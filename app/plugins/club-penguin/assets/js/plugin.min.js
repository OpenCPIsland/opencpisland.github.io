/*! Club Penguin Extras Plugin
 * https://github.wdig.com/clubpenguin/tm-plugin-club-penguin
 * Copyright (c) 2018; * Licensed GPL-2.0+ */
var SNOWFLAKE=SNOWFLAKE||{},SNOWFLAKE_X=SNOWFLAKE_X||{},SF_DISNEYID=SF_DISNEYID||{},CLUB_PENGUIN=CLUB_PENGUIN||{};!function(a){CLUB_PENGUIN.app={token:null,loggedIn:!1,loginResponse:null,message:"",sessionTokenName:"cpi_token",sessionResponseName:"cpi_loginresponse",canStoreSessionData:!1,debug:!1,init:function(){var b=this;b.notification=SNOWFLAKE_X.Notifications.add("page"),void 0!==a.cookie(snowflake_extras.sc)&&(b.loggedIn=!0),"undefined"!=typeof Storage&&(b.canStoreSessionData=!0,b.getSessionStorageData())},reset:function(){var a=this;sessionStorage.removeItem(a.sessionTokenName),sessionStorage.removeItem(a.sessionResponseName),a.loggedIn=!1,a.loginResponse=null},login:function(b){var c=this;return c.getSessionStorageData(),void 0!==b&&b!=c.token&&(c.token=b,c.loggedIn=!1,c.canStoreSessionData&&(sessionStorage.setItem(c.sessionTokenName,c.token),sessionStorage.setItem(c.sessionResponseName,null))),c.loggedIn&&void 0!==a.cookie(snowflake_extras.sc)?(SF_DISNEYID.callbacks.blocks(),c.jsonResponseData=JSON.parse(c.loginResponse),c.message="Login Success ... [Token: <em>"+c.token+"</em> Timestamp: <em>"+c.jsonResponseData.timestamp+"</em>]",c.notification.set(c.message,"success",!1,!0),a("body").trigger("appLoginStatus",c.jsonResponseData),c.loginResponse):(c.message="Token received. Attempting to log in ... [Token: <em>"+c.token+"</em>]",c.notification.set(c.message,"waiting",!0),SF_DISNEYID.App.tokenLogin(c.token,"CLUB_PENGUIN.app.loginSuccess","CLUB_PENGUIN.app.loginFailure"))},loginSuccess:function(a){var b=this;return b.loggedIn=!0,b.message="Login Success ... [Token: <em>"+b.token+"</em> Timestamp: <em>"+a.timestamp+"</em>]",b.notification.set(b.message,"success",!1,!0),b.loginResponse=JSON.stringify(a),b.canStoreSessionData&&sessionStorage.setItem(b.sessionResponseName,b.loginResponse),SF_DISNEYID.callbacks.blocks(),b.loginResponse},loginFailure:function(a){var b=this;return b.loggedIn=!1,b.message="Login Failed ... [Token: <em>"+b.token+"</em>]",b.notification.set(b.message,"error"),b.loginResponse=JSON.stringify(a),b.canStoreSessionData&&sessionStorage.setItem(b.sessionResponseName,b.loginResponse),SF_DISNEYID.callbacks.blocks(),b.loginResponse},getSessionStorageData:function(){var a=this;a.canStoreSessionData&&("undefined"!==sessionStorage.getItem(a.sessionTokenName)&&null!==sessionStorage.getItem(a.sessionTokenName)&&(a.token=sessionStorage.getItem(a.sessionTokenName)),"undefined"!==sessionStorage.getItem(a.sessionResponseName)&&null!==sessionStorage.getItem(a.sessionResponseName)&&(a.loginResponse=sessionStorage.getItem(a.sessionResponseName)))}},a(document).ready(function(){SNOWFLAKE_X.App.isAppView&&CLUB_PENGUIN.app.init()})}(jQuery),function(a){CLUB_PENGUIN.DisplayNameUpdate={updateInProgress:!1,init:function(b){var c=this,d={action:"cp_user_displayname_set",displayname:b};c.updateInProgress||(c.updateInProgress=!0,a.post(ajaxurl,d,function(){},"json").done(function(a){c.updateInProgress=!1,void 0!==a.status&&"success"===a.status?SF_DISNEYID.ScreenDisplayName.updateSuccess(a.displayname):"error_in_progress"!=a.status&&SF_DISNEYID.ScreenDisplayName.updateError(a.message)}))}}}(jQuery);